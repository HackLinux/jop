<project name="build" default="build">
	
	<target name="init-with-arg3" if="arg3">
		
		<property name="project" value="${arg2}_${arg3}"/>
		<property name="startclass" value="${arg2}/${arg3}"/>
		<property name="appdir" value="${arg1}"/>
			
	</target>
	
	<target name="init-without-arg3" unless="arg3">
		
		<property name="project" value="${arg1}_${arg2}"/>
		<property name="startclass" value="${arg1}/${arg2}"/>
		<property name="appdir" value="$."/>
		
	</target>
	
	<target name="build" depends="init-with-arg3, init-without-arg3">
		
		<delete dir="dist"/>
		
		<mkdir dir="dist/classes"/>
		<mkdir dir="dist/lib"/>
		<mkdir dir="dist/bin"/>
		
		<javac debug="true" destdir="dist/classes">
			<src path="src/common"/>
			<include name="src/jdk/java/**"/>
			<include name="src/common/com/jopdesign/sys/**"/>
		</javac>

		<javac debug="true" destdir="dist/classes">
			<src path="src/common"/>
			<src path="src/bench"/>
			<src path="src/${appdir}"/>
			<include name="src/${appdir}/${startclass}.java"/>
		</javac>

		<jar basedir="dist/classes" destfile="dist/lib/classes.zip"/>

		<path id="java-lib">
			<pathelement location="../tools/dist/lib/jop-tools.jar"/>
			<pathelement location="../lib/bcel-5.1.jar"/>
			<pathelement location="../lib/jakarta-regexp-1.3.jar"/>
		</path>
		
		<java
			classpathref="java-lib"
			classname="com.jopdesign.build.JOPizer"
			failonerror="true"
			fork="true">
			<sysproperty key="mgci" value="false"/>
			<arg line="-cp dist/lib/classes.zip -o dist/bin/${project}.jop ${startclass}"/>
		</java>

		<!-- this is the 'old' JCC version -->
		<!-- <java classname="JavaCodeCompact" failonerror="true" fork="true"> -->
		<!-- 	<classpath> -->
		<!-- 		<pathelement location="../tools/jcc.jar"/> -->
		<!-- 		<pathelement location="../tools/dist/lib/jop-tools.jar"/> -->
		<!-- 	</classpath> -->
		<!-- 	<sysproperty key="jop.startclass" value="${startclass}"/> -->
		<!-- 	<arg line="-nq -arch JOP -o dist/bin/${project}.jop dist/lib/classes.zip"/> -->
		<!-- </java> -->
		 
		<java
			classpath="../tools/dist/lib/jop-tools.jar"
			classname="com.jopdesign.tools.jop2dat"
			failonerror="true"
			fork="true">
			<arg line="dist/bin/${project}.jop"/>
		</java>

		<move todir="../../modelsim">
			<fileset dir="${basedir}">
				<include name="*.dat"/>
			</fileset>
		</move>

		<!-- <java classpath="../tools/dist/lib/jop-tools.jar" classname="com.jopdesign.tools.JopBitGen" failonerror="true" fork="true"> -->
		<!-- 	<arg line="dist/bin/${project}.jop dist/bin/${project}.bit"/> -->
		<!-- </java> -->
		
	</target>

</project>
